# 前端API迁移指南

本指南提供从旧API迁移到新API架构的步骤说明，帮助前端开发人员顺利完成迁移工作。

## 迁移概述

我们的API已经完成了重构，提供了更一致、更易于维护的架构。前端迁移需要分三个阶段进行：

1. **准备阶段**：使用新的API客户端，但保持原有的API调用
2. **迁移阶段**：逐步将直接API调用替换为使用API客户端
3. **完成阶段**：删除旧代码和迁移辅助函数

## 1. 准备阶段

### 1.1 了解新API结构

新API的路径结构已经调整为：

```
/api/storage/           - 所有存储相关操作的基础路径
  ├── files/            - 文件操作
  │   ├── search        - 文件搜索
  │   ├── upload        - 文件上传
  │   ├── delete        - 文件删除
  │   ├── move          - 文件移动
  │   ├── download      - 文件下载
  │   └── [id]/         - 单个文件操作
  │       ├── preview   - 文件预览
  │       └── content   - 文件内容
  ├── folders/          - 文件夹操作
  │   ├── [id]/         - 单个文件夹操作
  │   └── children      - 获取子项
  ├── favorites/        - 收藏操作
  │   ├── add           - 添加收藏
  │   └── remove        - 移除收藏
  ├── tags/             - 标签操作
  ├── recent            - 最近访问
  ├── stats             - 存储统计
  └── info              - 存储信息
```

### 1.2 导入API客户端

在所有需要API调用的组件中，导入新的API客户端：

```typescript
// 旧方式 - 直接调用API
// const response = await fetch('/api/storage/files/list');

// 新方式 - 使用API客户端
import { fileApi } from '@/app/lib/api/file-api';
```

## 2. 迁移阶段

### 2.1 文件列表API迁移

旧代码：
```typescript
// 获取文件列表
const response = await fetch(`/api/storage/files?folderId=${folderId}`);
const data = await response.json();
const files = data.files;
```

新代码：
```typescript
// 使用API客户端
const { items, total } = await fileApi.getFiles({ 
  folderId, 
  page: 1, 
  pageSize: 50 
});
```

### 2.2 文件上传API迁移

旧代码：
```typescript
const formData = new FormData();
formData.append('file', file);
const response = await fetch('/api/storage/files/upload', {
  method: 'POST',
  body: formData
});
const data = await response.json();
```

新代码：
```typescript
// 单个文件上传
const [result] = await fileApi.uploadFiles([file], tags, folderId);

// 多个文件上传
const results = await fileApi.uploadFiles(files, tags, folderId);
```

### 2.3 文件夹API迁移

旧代码：
```typescript
// 创建文件夹
const response = await fetch('/api/storage/folders', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ name, parentId })
});
const folder = await response.json();
```

新代码：
```typescript
// 创建文件夹
const folder = await fileApi.createFolder(name, parentId, tags);
```

### 2.4 搜索API迁移

旧代码：
```typescript
const response = await fetch(`/api/storage/files/search?query=${encodeURIComponent(query)}`);
const data = await response.json();
const results = data.results;
```

新代码：
```typescript
const results = await fileApi.searchFiles({ 
  query, 
  type, 
  tags 
});
```

### 2.5 文件操作API迁移

旧代码：
```typescript
// 删除文件
const response = await fetch('/api/storage/files/delete', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ fileIds: [fileId] })
});

// 移动文件
const response = await fetch('/api/storage/files/move', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ fileIds: [fileId], targetFolderId })
});
```

新代码：
```typescript
// 删除文件
const { deletedCount } = await fileApi.deleteFiles([fileId]);

// 移动文件
const { movedCount } = await fileApi.moveFiles([fileId], targetFolderId);
```

### 2.6 收藏和标签API迁移

这些是新增功能，直接使用新的API客户端：

```typescript
// 收藏功能
const { count } = await fileApi.addToFavorites([fileId]);
const { count } = await fileApi.removeFromFavorites([fileId]);
const { items } = await fileApi.getFavorites();

// 标签相关
const tags = await fileApi.getTags();
```

## 3. 完成阶段

### 3.1 移除旧代码

一旦确认所有组件已经成功迁移到新的API客户端：

1. 移除所有直接使用`fetch`调用API的代码
2. 移除旧的API路由（`/api/files/*`和`/api/folders/*`）

### 3.2 更新文档

更新所有涉及API调用的文档，反映新的API结构和推荐的调用方式。

### 3.3 测试验证

全面测试所有功能，确保：

- 所有API调用都使用最新的路径
- 文件上传、下载、删除等操作正常工作
- 错误处理正确实现

## 4. 常见问题

### 4.1 响应格式问题

如果遇到响应格式不一致的问题，请确保使用了统一的响应处理方式：

```typescript
try {
  const result = await fileApi.someMethod();
  // 成功处理
} catch (error) {
  // 错误处理
  console.error(error.message);
}
```

### 4.2 路径错误

如果遇到API调用404错误，请：

1. 检查API路径是否正确
2. 检查是否使用了正确的API路径。确保使用了`/api/storage/`前缀而不是旧的`/api/files/`路径。
3. 调试时检查网络请求的完整URL

### 4.3 权限问题

如果遇到权限问题（401/403错误），请确保：

1. 用户已正确登录
2. 认证token正确包含在请求中
3. 用户对请求的资源有访问权限

## 5. 迁移例子

### 5.1 完整迁移例子

这是一个文件列表组件的完整迁移示例：

```typescript
// 旧代码
const fetchFiles = async () => {
  try {
    const response = await fetch('/api/storage/files');
    const data = await response.json();
    
    if (data && data.files) {
      setFiles(data.files);
    }
  } catch (error) {
    console.error('获取文件失败:', error);
  }
};

// 新代码
import { fileApi } from '@/app/lib/api/file-api';

const fetchFiles = async () => {
  try {
    const { items } = await fileApi.getFiles();
    setFiles(items);
  } catch (error) {
    console.error('获取文件失败:', error);
  }
};
```

## 迁移检查清单

- [ ] 导入并使用API客户端
- [ ] 迁移文件列表获取
- [ ] 迁移文件上传功能
- [ ] 迁移文件夹操作
- [ ] 迁移搜索功能
- [ ] 迁移文件删除/移动
- [ ] 添加收藏和标签功能
- [ ] 更新错误处理
- [ ] 进行全面测试
- [ ] 移除旧代码

## 常见问题

### 一些API调用返回404

检查是否使用了正确的API路径。确保使用了`/api/storage/`前缀而不是旧的`/api/files/`路径。

### 错误处理不工作

确保正确捕获API客户端抛出的`ApiError`异常，而不是尝试检查响应状态码。

### 响应格式似乎不一致

确保您没有混合使用直接的`fetch`调用和API客户端。API客户端会处理响应格式并直接返回数据部分。 