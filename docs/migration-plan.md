# 项目结构优化迁移计划

## 目标

根据[目录结构规范](./directory-structure.md)重构项目结构，解决以下问题：

1. 消除功能冗余
2. 明确各层职责边界
3. 统一代码组织方式
4. 优化依赖关系

## 优先级与阶段

迁移工作将分为以下几个阶段，按优先级排序：

### 阶段1：文件处理逻辑整合

解决`lib/file`、`utils/file`和`lib/storage/file-handling`之间的重叠问题。

**步骤**：
1. 分析现有文件处理相关代码
2. 按照规范重新分配职责
3. 迁移代码到正确位置
4. 更新引用
5. 移除冗余代码

**预计影响**：
- `app/lib/file/fileUtils.ts`
- `app/utils/file/*`
- `app/lib/storage/file-handling/*`

### 阶段2：中间件整合

解决根目录`middleware.ts`与`app/middleware`的整合。

**步骤**：
1. 分析两处中间件的功能
2. 将根目录中间件功能迁移到`app/middleware`
3. 确保所有中间件在一处管理
4. 更新引用

**预计影响**：
- `middleware.ts`
- `app/middleware/*`

### 阶段3：存储功能重构

重构分散在各处的存储相关功能。

**步骤**：
1. 明确三层架构中存储相关职责
   - `lib/storage`：核心存储功能
   - `services/storage`：业务逻辑
   - `api/storage`：接口路由
2. 重新组织代码
3. 更新相关引用

**预计影响**：
- `app/lib/storage/*`
- `app/services/storage/*`
- `app/api/storage/*`

### 阶段4：类型定义集中

集中管理类型定义。

**步骤**：
1. 收集分散在各处的类型定义
2. 按功能域组织到`app/types/`目录
3. 更新导入引用

**预计影响**：
可能涉及多个文件中的类型定义

### 阶段5：utils与lib职责明确

明确`utils`和`lib`之间的职责边界。

**步骤**：
1. 审查两个目录中的内容
2. 根据职责重新分配：
   - 纯函数移至`utils`
   - 有状态/IO操作移至`lib`
3. 更新引用

**预计影响**：
- `app/utils/*`
- `app/lib/*`

## 具体迁移计划

### 阶段1详细计划：文件处理逻辑整合

#### 1.1 分析现有代码

```
迁移任务：分析文件处理代码
- 检查 app/lib/file/fileUtils.ts 中的功能
- 检查 app/utils/file/index.ts 及其他文件的功能
- 检查 app/lib/storage/file-handling/ 中的功能
- 识别功能重叠和职责不清的部分
```

#### 1.2 功能分类与重新分配

```
迁移任务：根据规范重新分配职责
- utils/file/ 应包含：
  - 文件类型检测
  - 文件大小格式化
  - 文件名处理
  - 路径处理工具函数
  - 其他无副作用的纯函数
  
- lib/file/ 应包含：
  - 文件读写操作
  - 文件上传/下载核心逻辑
  - 文件系统交互
  - 其他有IO操作的功能
```

#### 1.3 代码迁移

```
迁移任务：移动代码到正确位置
- 创建或更新 utils/file/ 下的文件
- 创建或更新 lib/file/ 下的文件
- 确保功能完整性
- 添加必要的单元测试
```

#### 1.4 更新引用

```
迁移任务：更新代码引用
- 识别所有引用旧位置文件的代码
- 更新引用路径
- 确保没有破坏现有功能
```

#### 1.5 移除冗余

```
迁移任务：清理冗余代码
- 移除已迁移的冗余文件或代码
- 确保没有功能丢失
```

### 阶段2-5的详细计划（类似结构）

...略（实际文档中应完整展开）

## 测试策略

每个迁移步骤完成后：

1. 运行单元测试确保功能正常
2. 手动测试关键功能
3. 检查引用路径是否正确更新
4. 验证是否符合新的目录结构规范

## 回滚计划

如果迁移过程中出现问题：

1. 记录当前状态
2. 回滚到上一个稳定版本
3. 分析问题原因
4. 调整迁移计划
5. 重新尝试迁移

## 完成标志

- 所有代码都位于正确的目录中
- 没有功能重复的代码
- 所有引用路径正确
- 所有测试通过
- 项目结构符合规范文档 